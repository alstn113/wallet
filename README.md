# 분산 환경에서의 정합성 보장 이체 시스템

## 개요

MSA 환경에서 발생할 수 있는 문제점들을 해결하고, 결과적 정합성을 보장하는 안전한 이체 시스템을 설계 및 구현합니다.

본 프로젝트는 다음의 사례를 참고하여 설계했습니다.

- 참고 자료
    - [도서] [가상 면접 사례로 배우는 대규모 시스템 설계 기초 2권 - 12장 전자 지갑](https://www.yes24.com/product/goods/124138645)
    - [영상] [토스 SLASH 24 - 보상 트랜잭션으로 분산 환경에서도 안전하게 환전하기](https://www.youtube.com/watch?v=xpwRTu47fqY)

## 학습 목표

- 트랜잭션 아웃박스 패턴 (Polling, CDC)
- 분산 트랜잭션 SAGA 패턴 (Orchestration)
- OpenFeign
- 데이터베이스 샤딩

## 기술 스택

- Kotlin, Java 21
- Spring Boot 3.5.8 (멀티모듈, 헥사고날 아키텍처)
- MySQL 8, Spring Data JPA
- Kafka, OpenFeign
- Docker, Testcontainers

## 구조

- transfer-app: 이체 요청을 받아 wallet-app에서 출금 및 입금을 처리
- transfer-db: 이체 데이터와 이체 로그 데이터 저장
- wallet-app: 출금 및 입금을 처리
- wallet-db: 지갑 데이터와 거래 데이터 저장, 샤딩 적용

## 고려할 부분

1. 출금 - HTTP 동기

    - Case A: 정상 처리
        - 출금 성공 → 입금 수행
    - Case B: 실패 응답
        - 잔액 부족 등 -> 이체 실패 응답
    - Case C: 타임아웃 또는 5XX 예외 발생
        - 즉시 출금 여부 조회 시도

        1. [조회 결과: 출금 성공]
            - 보상 트랜잭션(환불) 메세지 발행 -> 이체 실패 응답
        2. [조회 결과: 출금 실패]
            - 이체 실패 응답
        3. [조회 실패]
            - 출금 여부를 알 수 없음 -> 처리 중 응답
            - Kafka를 활용한 지연 재시도를 통해 상태 확인 후 처리

2. 입금 - HTTP 동기

    - Case A: 정상 처리
        - 입금 성공 → 이체 성공 응답
    - Case B: 타임아웃 또는 5XX 예외 발생
        - 즉시 입금 여부 조회 시도

        1. [조회 결과: 입금 성공]
            - 이체 성공 응답
        2. [조회 결과: 입금 실패]
            - 보상 트랜잭션(출금 취소) 메세지 발행 → 이체 실패 응답
        3. [조회 실패]
            - 입금 여부를 알 수 없음 -> 처리 중 응답
            - 입금된 돈이 빠졌을 수 있으므로 메세징만으로 처리 불가
            - Kafka를 활용한 지연 재시도를 통해 상태 확인 후 처리

3. 보상 트랜잭션 처리
    - 출금/입금 실패 시 보상 트랜잭션을 위한 메세지 발행 시
        - DB 트랜잭션 커밋과 메세지 발행의 원자성 보장 (트랜잭션 아웃박스 패턴)
    - 컨슈머(wallet-app)에서 보상 트랜잭션 실패 시 DLQ로 이동 후 수동 처리